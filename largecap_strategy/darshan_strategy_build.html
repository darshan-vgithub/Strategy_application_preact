<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flameback || Strategy</title>
    <link rel="icon" href="./assets/logo-favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <script type="module">
      import {
        html,
        render,
        useState,
      } from "https://esm.sh/htm/preact/standalone";
      import { Form } from "./form.js";
      import { AddFilterButton } from "./AddFilterButton.js";

      // Example strategy data, replace with actual data or state
      const strategies = {
        'Example Strategy': {
          class: 'ExampleClass',
          filters: [],
          universe: 'ExampleUniverse'
        }
      };

      function App() {
        const [strategyName, setStrategyName] = useState("");
        const [strategyData, setStrategyData] = useState({
          class: "",
          filters: [],
          universe: "",
        });
        const [availableFilters, setAvailableFilters] = useState([]);
        const [filterForms, setFilterForms] = useState([]);

        const handleStrategyNameChange = (e) => {
          const name = e.target.value.trim(); // Trim to avoid unwanted spaces
          setStrategyName(name);

          // Fetch and set strategy data
          if (strategies[name]) {
            setStrategyData({
              class: strategies[name].class || "",
              filters: strategies[name].filters || [],
              universe: strategies[name].universe || "",
            });
            setAvailableFilters(strategies[name].filters || []);
          } else {
            setStrategyData({ class: "", filters: [], universe: "" });
            setAvailableFilters([]);
          }
        };

        const handleAddFilter = () => {
          // Add a new filter form to the list
          setFilterForms((prevForms) => [
            ...prevForms,
            { id: Date.now(), filter: {} }, // Create a unique id and an empty filter object
          ]);
        };

        const handleFilterInputChange = (id, property, value) => {
          setFilterForms((prevForms) =>
            prevForms.map((form) =>
              form.id === id
                ? { ...form, filter: { ...form.filter, [property]: value } }
                : form
            )
          );
        };

        return html`
          <div style="padding: 20px;">
            <${Form}
              strategy=${strategyName}
              class_name=${strategyData.class || ""}
              universe=${strategyData.universe || ""}
              filters=${strategyData.filters || []}
              onStrategyNameChange=${handleStrategyNameChange}
            />
            <${AddFilterButton} onClick=${handleAddFilter} />
            <div>
              ${filterForms.map(
                (form) => html`
                  <div
                    key=${form.id}
                    style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                  >
                    <div class="filter-group" style="margin-bottom: 20px;">
                      <h4
                        style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: rgb(51, 51, 51);"
                      >
                        Market Cap Filter
                      </h4>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="min_market_cap_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Minimum Cap:
                        </label>
                        <input
                          type="number"
                          id="min_market_cap_${form.id}"
                          name="min_market_cap"
                          class="form-input"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.min_market_cap || ""}
                          onInput=${(e) => handleFilterInputChange(form.id, 'min_market_cap', e.target.value)}
                        />
                      </div>
                    </div>
                    <div class="filter-group" style="margin-bottom: 20px;">
                      <h4
                        style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: rgb(51, 51, 51);"
                      >
                        Generic Momentum Filter
                      </h4>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="calendar_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Calendar:
                        </label>
                        <select
                          id="calendar_${form.id}"
                          name="calendar"
                          class="form-select"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.calendar || ""}
                          onChange=${(e) => handleFilterInputChange(form.id, 'calendar', e.target.value)}
                        >
                          <option value="">Select Calendar</option>
                          <option value="XNSE">XNSE</option>
                          <option value="BCME">BCME</option>
                        </select>
                      </div>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="lookup_window_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Look up window:
                        </label>
                        <input
                          type="number"
                          id="lookup_window_${form.id}"
                          name="lookup_window"
                          class="form-input"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.lookup_window || ""}
                          onInput=${(e) => handleFilterInputChange(form.id, 'lookup_window', e.target.value)}
                        />
                      </div>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="return_size_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Return size:
                        </label>
                        <input
                          type="number"
                          id="return_size_${form.id}"
                          name="return_size"
                          class="form-input"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.return_size || ""}
                          onInput=${(e) => handleFilterInputChange(form.id, 'return_size', e.target.value)}
                        />
                      </div>
                    </div>
                    <div class="filter-group" style="margin-bottom: 20px;">
                      <h4
                        style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: rgb(51, 51, 51);"
                      >
                        Positive Movement Filter
                      </h4>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="calendar_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Calendar:
                        </label>
                        <select
                          id="calendar_${form.id}"
                          name="calendar"
                          class="form-select"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.calendar || ""}
                          onChange=${(e) => handleFilterInputChange(form.id, 'calendar', e.target.value)}
                        >
                          <option value="">Select Calendar</option>
                          <option value="XNSE">XNSE</option>
                          <option value="BCME">BCME</option>
                        </select>
                      </div>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="lookup_window_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Look up window:
                        </label>
                        <input
                          type="number"
                          id="lookup_window_${form.id}"
                          name="lookup_window"
                          class="form-input"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.lookup_window || ""}
                          onInput=${(e) => handleFilterInputChange(form.id, 'lookup_window', e.target.value)}
                        />
                      </div>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <label
                          for="positive_return_size_${form.id}"
                          style="display: block; margin-bottom: 5px; font-weight: bold; color: rgb(85, 85, 85);"
                        >
                          Positive return size:
                        </label>
                        <input
                          type="number"
                          id="positive_return_size_${form.id}"
                          name="positive_return_size"
                          class="form-input"
                          style="padding: 8px; border: 1px solid rgb(221, 221, 221); border-radius: 4px; width: 100%;"
                          value=${form.filter.positive_return_size || ""}
                          onInput=${(e) => handleFilterInputChange(form.id, 'positive_return_size', e.target.value)}
                        />
                      </div>
                    </div>
                  </div>
                `
              )}
            </div>
          </div>
        `;
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
