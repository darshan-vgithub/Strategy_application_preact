<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flameback || Strategy</title>
    <link rel="icon" href="./assets/logo-favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <script type="module">
        import { html, render, useState } from "https://esm.sh/htm/preact/standalone";
      import { Form } from "./form.js";
      import strategies from "./strategies.json" with { type: "json" };
      import { AddFilterButton } from "./AddFilterButton.js";
      import { FilterForm } from "./FilterForm.js"; // Import the FilterForm component

      function App() {
        const [strategyName, setStrategyName] = useState("");
        const [strategyData, setStrategyData] = useState({
          class: "",
          filters: [],
          universe: ""
        });
        const [availableFilters, setAvailableFilters] = useState([]);
        const [showFilterForm, setShowFilterForm] = useState(false); // State to control the visibility of the filter form
        const [currentFilter, setCurrentFilter] = useState(null); // Store current filter data

        const handleStrategyNameChange = (e) => {
          const name = e.target.value.trim();
          setStrategyName(name);

          if (strategies[name]) {
            setStrategyData({
              class: strategies[name].class || "",
              filters: strategies[name].filters || [],
              universe: strategies[name].universe || ""
            });
            setAvailableFilters(strategies[name].filters || []);
          } else {
            setStrategyData({ class: "", filters: [], universe: "" });
            setAvailableFilters([]);
          }
        };

        const handleAddFilter = (filter) => {
          setCurrentFilter(filter);
          setShowFilterForm(!showFilterForm); // Show filter form when adding a new filter
        };

        const handleFilterFormSubmit = (filterData) => {
          console.log("New Filter Data:", filterData);
          // Handle the filter data (e.g., add to form, save, etc.)
          setShowFilterForm(false); // Hide filter form after submission
        };

        return html`
          <${Form}
            strategy=${strategyName}
            class_name=${strategyData.class || ""}
            universe=${strategyData.universe || ""}
            filters=${strategyData.filters || []}
            onStrategyNameChange=${handleStrategyNameChange}
          />
          <${AddFilterButton}
            availableFilters=${availableFilters}
            onAddFilter=${handleAddFilter}
          />
          ${showFilterForm && html`
            <${FilterForm}
              filter=${currentFilter}
              onSubmit=${handleFilterFormSubmit}
              onCancel=${() => setShowFilterForm(false)}
            />
          `}
        `;
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
