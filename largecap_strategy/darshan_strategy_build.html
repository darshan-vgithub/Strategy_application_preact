<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flameback || Strategy</title>
    <link rel="icon" href="./assets/logo-favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <script type="module">
      import {
        html,
        render,
        useState,
      } from "https://esm.sh/htm/preact/standalone";
      import { Form } from "./form.js";
      import { AddFilterButton } from "./AddFilterButton.js";
      import { FilterForm } from "./FilterForm.js";
      import { Toast } from "./Toast.js"; // Import the Toast component
      import { CustomFilters } from "./CustomFilters.js"; // Import the CustomFilters component

      const strategies = {
        "Example Strategy": {
          class: "ExampleClass",
          filters: [],
          universe: "ExampleUniverse",
        },
      };

      function App() {
        const [strategyName, setStrategyName] = useState("");
        const [strategyData, setStrategyData] = useState({
          class: "",
          filters: [],
          universe: "",
        });
        const [availableFilters, setAvailableFilters] = useState([]);
        const [filterForms, setFilterForms] = useState([]);
        const [toastMessage, setToastMessage] = useState("");
        const [toastType, setToastType] = useState("success"); // 'success' or 'error'
        const [customFilters, setCustomFilters] = useState([
          {
            name: "customFilter1",
            label: "Custom Filter 1",
            type: "text",
            value: "",
          },
          {
            name: "customFilter2",
            label: "Custom Filter 2",
            type: "number",
            value: "",
          },
          // Add more filters as needed
        ]);

        const handleStrategyNameChange = (e) => {
          const name = e.target.value.trim(); // Trim to avoid unwanted spaces
          setStrategyName(name);

          // Fetch and set strategy data
          if (strategies[name]) {
            setStrategyData({
              class: strategies[name].class || "",
              filters: strategies[name].filters || [],
              universe: strategies[name].universe || "",
            });
            setAvailableFilters(strategies[name].filters || []);
          } else {
            setStrategyData({ class: "", filters: [], universe: "" });
            setAvailableFilters([]);
          }
        };

        const handleAddFilter = () => {
          // Add a new filter form to the list
          setFilterForms((prevForms) => [
            ...prevForms,
            { id: Date.now(), filter: {} }, // Create a unique id and an empty filter object
          ]);
          // Show success toast
          setToastMessage("Filter added successfully!");
          setToastType("success");
          setTimeout(() => setToastMessage(""), 3000); // Hide toast after 3 seconds
        };

        const handleFilterInputChange = (id, property, value) => {
          setFilterForms((prevForms) =>
            prevForms.map((form) =>
              form.id === id
                ? { ...form, filter: { ...form.filter, [property]: value } }
                : form
            )
          );
        };

        const handleDeleteFilter = (id) => {
          setFilterForms((prevForms) =>
            prevForms.filter((form) => form.id !== id)
          );
          // Show success toast
          setToastMessage("Filter deleted successfully!");
          setToastType("error");
          setTimeout(() => setToastMessage(""), 3000); // Hide toast after 3 seconds
        };

        const handleCustomFilterChange = (index, newValue) => {
          const updatedFilters = customFilters.map((filter, i) =>
            i === index ? { ...filter, value: newValue } : filter
          );
          setCustomFilters(updatedFilters);
        };

        return html`
          <${Form}
            strategy=${strategyName}
            class_name=${strategyData.class || ""}
            universe=${strategyData.universe || ""}
            filters=${strategyData.filters || []}
            onStrategyNameChange=${handleStrategyNameChange}
          />
          <${AddFilterButton} onClick=${handleAddFilter} />
          <div>
            ${filterForms.map(
              (form) => html`
                <${FilterForm}
                  form=${form}
                  handleFilterInputChange=${handleFilterInputChange}
                  handleDelete=${handleDeleteFilter}
                />
              `
            )}
          </div>
          <${CustomFilters}
            filters=${customFilters}
            handleFilterChange=${handleCustomFilterChange}
          />
          <${Toast} message=${toastMessage} type=${toastType} />
        `;
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
